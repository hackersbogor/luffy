<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Auto Key API</title>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
</head>
<body>
<script>
/* 1. FIREBASE CONFIG (SESUAI PROJECT LO) */
 const firebaseConfig = {
    apiKey: "AIzaSyAeX5hAtzavOQfUITVnRwnQFo1rsRexaps",
    authDomain: "miawkazuoptzfree.firebaseapp.com",
    databaseURL: "https://miawkazuoptzfree-default-rtdb.firebaseio.com",
    projectId: "miawkazuoptzfree",
    storageBucket: "miawkazuoptzfree.firebasestorage.app",
    messagingSenderId: "287886737399",
    appId: "1:287886737399:web:92cb927eb2426f2bd278f2",
    measurementId: "G-8GXS0QYXL4"
 };
firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref('vip_codes');

/* 2. AMBIL PARAMETER DARI URL */
const p = new URLSearchParams(location.search);
const create  = p.get('create') === '1';
const days    = parseInt(p.get('days')   || 0);
const hours   = parseInt(p.get('hours')  || 0);
const minutes = parseInt(p.get('minutes')|| 0);
const seconds = parseInt(p.get('seconds')|| 0);
const limit   = p.get('limit') || 'unlimited';
let   code    = p.get('code');

/* 3. HITUNG TOTAL MS + DEBUG */
const totalMs = (days*24*60*60*1000) + (hours*60*60*1000) + (minutes*60*1000) + (seconds*1000);
console.log({create, days, hours, minutes, seconds, code, totalMs});

/* 4. VALIDASI */
if(!create || totalMs <= 0 || !code){
  document.write(JSON.stringify({error:"param kurang atau durasi 0"}));
  throw 1;
}
if(code.length !== 6 || isNaN(code)){
  document.write(JSON.stringify({error:"code harus 6 digit angka"}));
  throw 1;
}

/* 5. SIAPKAN OBJECT */
const now = Date.now();
const payload = {
  createdAt: now,
  expiryTimestamp: now + totalMs,
  durationMs: totalMs,
  deviceLimit: limit,
  activeCount: 0,
  isManuallyExpired: false,
  activatedDevices: {}
};

/* 6. KIRIM KE FIREBASE */
db.child(code).set(payload)
  .then(()=> document.write(JSON.stringify({success:true, key:code})) )
  .catch(e=> document.write(JSON.stringify({error:e.message})) );
</script>
</body>
</html>
